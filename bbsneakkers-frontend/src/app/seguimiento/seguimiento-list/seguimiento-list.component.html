<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de KPIs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        .glass-effect {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.95);
        }
        .chart-container {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        .kpi-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-left-color: #3b82f6;
        }
        .tab-active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .tab-inactive {
            background: rgba(229, 231, 235, 0.5);
            color: #6b7280;
        }
        .tab-inactive:hover {
            background: rgba(229, 231, 235, 0.8);
            color: #374151;
        }
        .metric-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .frequency-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header con gradiente mejorado -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent mb-2">
                Seguimiento de KPIs
            </h1>
            <p class="text-gray-600 text-lg">Monitorea y registra el progreso de tus indicadores clave</p>
            <div class="mt-4 h-1 w-20 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full mx-auto"></div>
        </div>

        <!-- Sección principal mejorada -->
        <div class="bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden">
            <!-- Header de la sección -->
            <div class="bg-gradient-to-r from-gray-50 to-slate-100 px-8 py-6 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Indicadores de Rendimiento</h2>
                        <p class="text-gray-600">Gestiona y da seguimiento a todos tus KPIs</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-500">
                            <span class="inline-flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                KPIs Activos
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de KPIs mejorada -->
            <div class="p-8">
                <div class="space-y-4">
                    <div *ngFor="let kpis of kpis" class="kpi-card bg-white rounded-xl shadow-lg border border-gray-200 p-6 hover:shadow-xl transition-all duration-300">
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                            <div class="flex-1">
                                <div class="flex items-center mb-3">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg mr-4">
                                        📊
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800 mb-1">{{ kpis.nombre }}</h3>
                                        <div class="flex flex-wrap gap-2">
                                            <span class="metric-badge inline-flex items-center px-3 py-1 rounded-full text-xs font-medium text-white">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                Meta: {{ kpis.meta }} {{ kpis.unidad_medida }}
                                            </span>
                                            <span class="frequency-badge inline-flex items-center px-3 py-1 rounded-full text-xs font-medium text-white">
                                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                {{ kpis.frecuencia }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-3">
                                <button (click)="abrirFormulario(kpis)" 
                                        class="group relative inline-flex items-center justify-center px-6 py-3 overflow-hidden font-semibold text-white transition-all duration-300 ease-in-out rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-blue-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                    <span class="absolute inset-0 w-full h-full bg-gradient-to-r from-blue-600 to-purple-700 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></span>
                                    <svg class="relative z-10 w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    <span class="relative z-10">Registrar Seguimiento</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL MEJORADO -->
    <div *ngIf="selectedKPI" class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-900 bg-opacity-75 backdrop-blur-sm" aria-hidden="true"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            
            <div class="inline-block w-full max-w-6xl my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-2xl rounded-3xl glass-effect slide-in">
                <!-- Header del modal mejorado -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-8 py-6 text-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-white font-bold text-xl mr-4">
                                📈
                            </div>
                            <div>
                                <h3 class="text-2xl font-bold">{{ selectedKPI.nombre }}</h3>
                                <p class="text-blue-100 mt-1">Seguimiento y análisis detallado</p>
                            </div>
                        </div>
                        <button (click)="cerrarModal()" 
                                class="p-2 text-white hover:text-gray-200 hover:bg-white hover:bg-opacity-20 rounded-full transition-all duration-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Tabs mejorados -->
                <div class="bg-gray-50 px-8 py-4 border-b border-gray-200">
                    <div class="flex space-x-2">
                        <button (click)="activeTab = 'formulario'"
                                [class]="activeTab === 'formulario' ? 'tab-active px-6 py-3 rounded-xl font-semibold text-sm transition-all duration-200 shadow-md' : 'tab-inactive px-6 py-3 rounded-xl font-semibold text-sm transition-all duration-200'">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Registrar Seguimiento
                        </button>
                        <button (click)="activeTab = 'grafico'; prepararDatosGrafico()"
                                [class]="activeTab === 'grafico' ? 'tab-active px-6 py-3 rounded-xl font-semibold text-sm transition-all duration-200 shadow-md' : 'tab-inactive px-6 py-3 rounded-xl font-semibold text-sm transition-all duration-200'">
                            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Ver Gráfico y Análisis
                        </button>
                    </div>
                </div>

                <!-- Contenido del modal -->
                <div class="p-8 max-h-96 overflow-y-auto">
                    <!-- TAB: REGISTRO MEJORADO -->
                    <div *ngIf="activeTab === 'formulario'" class="fade-in">
                        <div class="max-w-2xl mx-auto">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6 mb-6">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">Nuevo Registro de Seguimiento</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="font-medium">Meta:</span>
                                        <span class="ml-2 text-green-600 font-semibold">{{ selectedKPI.meta }} {{ selectedKPI.unidad_medida }}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-orange-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="font-medium">Frecuencia:</span>
                                        <span class="ml-2 text-orange-600 font-semibold">{{ selectedKPI.frecuencia }}</span>
                                    </div>
                                </div>
                            </div>

                            <form (ngSubmit)="registrar()" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                        Valor Actual
                                    </label>
                                    <input [(ngModel)]="valor_actual" name="valor_actual" type="number" required
                                           placeholder="Ingrese el valor actual del KPI"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 shadow-sm" />
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                        </svg>
                                        Comentario (Opcional)
                                    </label>
                                    <textarea [(ngModel)]="comentario" name="comentario" 
                                              placeholder="Agregue comentarios adicionales sobre este registro..."
                                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 shadow-sm resize-none" 
                                              rows="3"></textarea>
                                </div>
                                
                                <button type="submit" 
                                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl font-semibold hover:from-green-600 hover:to-emerald-700 focus:outline-none focus:ring-4 focus:ring-green-200 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Guardar Seguimiento
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- TAB: GRÁFICO MEJORADO -->
<ng-template #noData>
  <div class="text-center py-16">
    <div class="text-gray-300 text-8xl mb-6">📊</div>
    <h3 class="text-2xl font-bold text-gray-400 mb-4">No hay seguimientos registrados</h3>
    <p class="text-gray-500 text-lg mb-8 max-w-md mx-auto">
      Registra tu primer seguimiento para comenzar a visualizar el progreso de este KPI.
    </p>
    <button (click)="activeTab = 'formulario'" 
            class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
      </svg>
      Crear Primer Registro
    </button>
  </div>
</ng-template>

<div *ngIf="activeTab === 'grafico'" class="fade-in">
  <ng-container *ngIf="selectedKPI.seguimientos?.length > 0; else noData">
    <!-- Métricas del KPI -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-6 text-center">
        <div class="text-3xl text-blue-600 mb-2">🎯</div>
        <div class="text-2xl font-bold text-blue-800">{{ selectedKPI.meta }}</div>
        <div class="text-sm text-blue-600">{{ selectedKPI.unidad_medida }}</div>
        <div class="text-xs text-gray-500 mt-1">Meta Establecida</div>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6 text-center">
        <div class="text-3xl text-green-600 mb-2">📊</div>
        <div class="text-2xl font-bold text-green-800">{{ selectedKPI.seguimientos.length }}</div>
        <div class="text-sm text-green-600">Registros</div>
        <div class="text-xs text-gray-500 mt-1">Total de Seguimientos</div>
      </div>

      <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-6 text-center">
        <div class="text-3xl text-orange-600 mb-2">⏱️</div>
        <div class="text-lg font-bold text-orange-800">{{ selectedKPI.frecuencia }}</div>
        <div class="text-sm text-orange-600">Frecuencia</div>
        <div class="text-xs text-gray-500 mt-1">Periodicidad</div>
      </div>
    </div>

    <!-- Gráfico -->
    <div class="chart-container rounded-2xl p-6 shadow-lg mb-8">
      <h4 class="text-lg font-semibold text-gray-800 mb-4 text-center">
        📈 Evolución del KPI
      </h4>
      <ngx-charts-line-chart
        [view]="view"
        [results]="chartData"
        [xAxis]="true"
        [yAxis]="true"
        [legend]="true"
        [showXAxisLabel]="true"
        [showYAxisLabel]="true"
        xAxisLabel="Fecha"
        yAxisLabel="Valor">
      </ngx-charts-line-chart>
    </div>

    <!-- Tabla -->
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
      <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          Histórico de Seguimientos
        </h4>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                Fecha
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                Valor
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                Comentario
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-100">
            <tr *ngFor="let s of selectedKPI.seguimientos; let i = index" class="hover:bg-gray-50 transition-colors duration-200">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-xs font-semibold mr-3">
                    {{ i + 1 }}
                  </div>
                  <div class="text-sm font-medium text-gray-900">
                    {{ formatearFecha(s.fecha_registro) }}
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-semibold text-gray-900">{{ s.valor_actual }}</div>
                <div class="text-xs text-gray-500">{{ selectedKPI.unidad_medida }}</div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-600 max-w-xs">
                  {{ s.comentario || 'Sin comentario' }}
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </ng-container>
</div>
